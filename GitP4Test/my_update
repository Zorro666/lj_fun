#! /bin/bash

autorun=0
#set -x
function ask()
{
	cmd=$*
	if [ $autorun -eq 0 ]; then
		echo -n "Run '$cmd' [*y*/n/a] ? "
		read answer
	fi
	run=1
	if [ "$answer" == "a" ]; then
		autorun=1
	fi
	if [ "$answer" == "n" ]; then
		run=0
		fi
	if [ $run -eq 1 ]; then
		$cmd
		result=$?
		if [ $result -ne 0 ]; then
			echo "'$cmd' failed"
			autorun=0
			return $result;
		fi
	fi
}

ask git add .
ask git commit -a -m "Auto Update" --author="Perforce <perforce@import.com>"
ask git log Perforce_Sync...HEAD --name-status -B --no-renames --oneline >log.txt
#ask git tag -d Perforce_Sync
#ask git tag Perforce_Sync
awk '{if ( $1 == "A" ) { f=sprintf( "%s%s%s",$2,$3,$4); printf("%s\n",f); } }' log.txt >adds.txt
awk '{if ( $1 == "M" ) { f=sprintf( "%s%s%s",$2,$3,$4); printf("%s\n",f); } }' log.txt >edits.txt
awk '{if ( $1 == "D" ) { f=sprintf( "%s%s%s",$2,$3,$4); printf("%s\n",f); } }' log.txt >dels.txt
echo "Adds"
echo >p4adds
for file in `cat adds.txt`
do
	echo $file
	p4file=`p4 -p localhost:1666 where $file | awk '{print $1}'`
	echo "p4 -p localhost:1666 add $p4file" >>p4adds
done
cat p4adds
echo "Edits"
echo >p4edits
for file in `cat edits.txt`
do
	echo $file
	p4file=`p4 -p localhost:1666 where $file | awk '{print $1}'`
	echo "p4 -p localhost:1666 edit $p4file" >>p4edits
done
cat p4edits
echo "Deletes"
echo >p4dels
for file in `cat dels.txt`
do
	echo $file
	p4file=`p4 -p localhost:1666 where $file | awk '{print $1}'`
	echo "p4 -p localhost:1666 delete $p4file" >>p4dels
done
cat p4dels
